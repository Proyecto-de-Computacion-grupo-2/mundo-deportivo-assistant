import csv

from time import sleep

# from selenium.webdriver.common.action_chains import ActionChains
from selenium.webdriver.common.by import By
from selenium.webdriver.support import expected_conditions as ec
from selenium.common.exceptions import NoSuchElementException
from selenium import webdriver
from selenium.webdriver.support.ui import WebDriverWait

# Configura el navegador (en este caso, Firefox)
firefox_options = webdriver.FirefoxOptions()
firefox_options.add_argument("--headless")  # Esta línea oculta el navegador
driver = webdriver.Firefox(options = firefox_options)
driver_pers = webdriver.Firefox(options = firefox_options)

# Abre la URL
driver.get("https://www.laliga.com/estadisticas-avanzadas")

# Espera a que se cargue el contenido (puedes ajustar el tiempo de espera según sea necesario)
wait1 = WebDriverWait(driver, 10)
wait2 = WebDriverWait(driver_pers, 10)

c = 1

# Inicializa una lista para almacenar los datos por categoría
categorias = ["Clásicas", "Eficiencia", "Disciplina", "Ataques", "Defensivas"]
categoria_pers, categoria_extra, enlaces_jugadores = [], [], []
datos_por_categoria = {categoria: [] for categoria in categorias}

categoria_actual_index, i = 0, 0

while c < 30:

    # Itera a través de las categorías
    while i < 5:
        # Encuentra el selector de categorías
        selector_categorias = driver.find_element(By.XPATH, '//ul[@class="styled__ItemsList-sc-d9k1bl-2 kmSkaE"]')
        # visualizar_categorias = driver.find_element(By.XPATH,
        #                                             '//div[@class="styled__BreadCrumbContainer-sc-zvm62g-0 jOpRUj"]')

        # Selecciona la categoría actual
        if c == 1:
            # Realiza un scroll hacia arriba de la página
            # driver.execute_script("window.scrollTo(0, 0);")

            driver.execute_script(f"arguments[0].click();",
                                  driver.find_element(By.XPATH,
                                                      '//div[@class="styled__DropdownContainer-sc-d9k1bl-0 dimymR"]'))
            categoria_selector = wait1.until(ec.element_to_be_clickable(
                (By.XPATH, f'//li[contains(@class, "styled__Item-sc-d9k1bl-3") and text()="{categorias[i]}"]')))

            # Usa ActionChains para mover el cursor sobre el elemento antes de hacer click.
            # sleep(0.5)
            # ActionChains(driver).move_to_element(categoria_selector).perform()
            # sleep(0.5)

            driver.execute_script("arguments[0].click();", categoria_selector)

        # Espera a que se cargue la tabla
        tabla = wait1.until(
            ec.presence_of_element_located((By.XPATH, '//table[@class="styled__TableStyled-sc-57jgok-1 kvoOOd"]')))
        # driver.execute_script("arguments[0].scrollIntoView(true);", tabla)

        if c == 1:
            # Encuentra todas las filas de la tabla.
            filas = tabla.find_elements(By.TAG_NAME, "th")
            nombres_cabecera = []
            for fila in filas:

                if fila.get_dom_attribute("data-tip"):
                    nombres_cabecera.append(fila.get_dom_attribute("data-tip"))
            datos_por_categoria[categorias[i]].append(nombres_cabecera)

        # Recorre todas las filas y obtiene los datos de cada celda.
        filas = tabla.find_elements(By.TAG_NAME, "tr")
        for fila in filas:
            celdas = fila.find_elements(By.TAG_NAME, "td")
            fila_datos = []
            for celda in celdas:
                try:
                    elemento_a = celda.find_element(By.XPATH, './/a[@class="link"]')
                    enlace_href = elemento_a.get_attribute("href")
                    if "jugador" in enlace_href and enlace_href not in enlaces_jugadores:
                        enlaces_jugadores.append(enlace_href)
                except NoSuchElementException:
                    pass
                fila_datos = [celda.text]
                if fila_datos:
                    datos_por_categoria[categorias[i]].append(fila_datos[1:])

        # Incrementa página (c).
        c += 1
        if c != 30:
            elemento = wait1.until(ec.visibility_of_element_located(
                (By.XPATH, '//div[@class="styled__PaginationArrow-sc-1c62lz0-5 dTBfXp"]')))
            driver.execute_script("arguments[0].scrollIntoView(true);", elemento)
            driver.execute_script("arguments[0].click();", elemento)
            sleep(0.8)
        else:
            # Pasa a la siguiente categoría y resetea a la primera página.
            c, i = 1, i + 1
    if i == 5:
        c = 30

for jugador in enlaces_jugadores:
    driver_pers.get(jugador)
    datos_personales = wait2.until(
            ec.presence_of_element_located((By.XPATH, '//div[@class="styled__TableData-sc-yr5r72-13 jQgbxa"]')))
    posicion = driver_pers.find_element(By.XPATH, '//p[@class="styled__TextRegularStyled-sc-1raci4c-0 fiTkPc"]')

# Cierra el navegador al finalizar
driver.quit()

# Crear una lista de encabezados a partir de la clave 1
encabezado_1 = datos_por_categoria["Clásicas"][0][1:]
encabezado_2 = datos_por_categoria["Eficiencia"][0][2:]
encabezado_3 = datos_por_categoria["Disciplina"][0][2:]
encabezado_4 = datos_por_categoria["Ataques"][0][2:]
encabezado_5 = datos_por_categoria["Defensivas"][0][2:]
encabezado = []
for i in encabezado_1:
    encabezado.append(i)
for i in encabezado_2:
    encabezado.append(i)
for i in encabezado_3:
    encabezado.append(i)
for i in encabezado_4:
    encabezado.append(i)
for i in encabezado_5:
    encabezado.append(i)

todos_los_jugadores = []

for i in range(len(datos_por_categoria["Clásicas"][1:])):
    dato_por_jugador = []
    for dato in datos_por_categoria["Clásicas"][i + 1][1:]:
        dato_por_jugador.append(dato)
    for dato in datos_por_categoria["Eficiencia"][i + 1][2:]:
        dato_por_jugador.append(dato)
    for dato in datos_por_categoria["Disciplina"][i + 1][2:]:
        dato_por_jugador.append(dato)
    for dato in datos_por_categoria["Ataques"][i + 1][2:]:
        dato_por_jugador.append(dato)
    for dato in datos_por_categoria["Defensivas"][i + 1][2:]:
        dato_por_jugador.append(dato)
    todos_los_jugadores.append(dato_por_jugador)

for jugador in todos_los_jugadores:
    # Crea un archivo CSV con el nombre del jugador.
    with open(f'jugadores/{jugador[0].replace(" ", "_")}.csv', "w", newline = "") as archivo_csv:
        escritor_csv = csv.writer(archivo_csv)
        # Escribe el encabezado en el archivo CSV
        escritor_csv.writerow(encabezado)
        # Escribe los datos en el archivo CSV
        escritor_csv.writerow(jugador)
